name: PR Deployment Status

on:
  status:
    # Triggers when commit status changes (including Amplify deployments)
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  sync-deployment-on-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      checks: read
    if: github.event_name == 'status'
    
    steps:
      - name: Check if Amplify status
        id: check-status
        run: |
          CONTEXT="${{ github.event.context }}"
          STATE="${{ github.event.state }}"
          
          # Check if this is an Amplify-related status
          if [[ "$CONTEXT" =~ [Aa]mplify ]]; then
            echo "is_amplify=true" >> $GITHUB_OUTPUT
            echo "context=$CONTEXT" >> $GITHUB_OUTPUT
            echo "state=$STATE" >> $GITHUB_OUTPUT
            echo "target_url=${{ github.event.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "is_amplify=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get PR info for commit
        if: steps.check-status.outputs.is_amplify == 'true'
        id: pr-info
        run: |
          # Find the PR associated with this commit
          PR_INFO=$(gh api repos/${{ github.repository }}/commits/${{ github.event.sha }}/pulls \
            -X GET \
            --jq '.[] | select(.state == "open") | {number: .number, sha: .head.sha}' \
            | head -n 1)
          
          if [ -n "$PR_INFO" ]; then
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
            PR_SHA=$(echo "$PR_INFO" | jq -r '.sha')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
            echo "✅ Found PR #$PR_NUMBER"
          else
            echo "⏭️ No open PR found for this commit"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update GitHub deployment
        if: steps.check-status.outputs.is_amplify == 'true' && steps.pr-info.outputs.pr_number != ''
        id: deployment
        run: |
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          DEPLOYMENT_URL="${{ steps.check-status.outputs.target_url }}"
          STATE="${{ steps.check-status.outputs.state }}"
          
          # Check if deployment already exists
          EXISTING_DEPLOY=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" \
            | head -1)
          
          if [ -z "$EXISTING_DEPLOY" ]; then
            # Create new deployment
            echo "Creating deployment for PR ${{ steps.pr-info.outputs.pr_number }}"
            DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
              -X POST \
              -f ref="${{ steps.pr-info.outputs.pr_sha }}" \
              -f environment="$ENVIRONMENT" \
              -f auto_merge=false \
              -f required_contexts='[]' \
              -f description="Preview deployment for PR #${{ steps.pr-info.outputs.pr_number }}" \
              -f payload="{\"url\":\"$DEPLOYMENT_URL\",\"pr_number\":\"${{ steps.pr-info.outputs.pr_number }}\"}" \
              --jq '.id')
            
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "Deployment already exists: $EXISTING_DEPLOY"
            echo "deployment_id=$EXISTING_DEPLOY" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update deployment status
        if: steps.deployment.outputs.deployment_id != ''
        run: |
          STATE="${{ steps.check-status.outputs.state }}"
          DEPLOYMENT_ID="${{ steps.deployment.outputs.deployment_id }}"
          
          # Map GitHub status states to deployment states
          case "$STATE" in
            "success")
              DEPLOY_STATE="success"
              DESC="Deployed successfully to Amplify"
              ;;
            "failure"|"error")
              DEPLOY_STATE="failure"
              DESC="Deployment failed on Amplify"
              ;;
            "pending")
              DEPLOY_STATE="in_progress"
              DESC="Deployment in progress on Amplify"
              ;;
            *)
              DEPLOY_STATE="in_progress"
              DESC="Deployment status updated"
              ;;
          esac
          
          gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
            -X POST \
            -f state="$DEPLOY_STATE" \
            -f description="$DESC" \
            -f environment_url="${{ steps.check-status.outputs.target_url }}"
          
          echo "Updated deployment status: $DEPLOY_STATE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  manage-deployment-on-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      checks: read
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Set environment variables
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"
          ACTION="${{ github.event.action }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
      
      - name: Wait and poll for Amplify deployment
        if: github.event.action != 'closed'
        id: poll-amplify
        run: |
          echo "⏳ Waiting for AWS Amplify to deploy PR #${{ steps.pr-info.outputs.pr_number }}..."
          
          TIMEOUT=300  # 5 minutes
          ELAPSED=0
          SLEEP_INTERVAL=15
          MAX_ATTEMPTS=$((TIMEOUT / SLEEP_INTERVAL))
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Checking for Amplify status (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)..."
            
            STATUSES=$(gh api repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_sha }}/statuses 2>/dev/null || echo "[]")
            
            # Look for Amplify status
            AMPLIFY_STATUS=$(echo "$STATUSES" | jq -r '[.[] | select(.context | ascii_downcase | contains("amplify"))][0]')
            
            if [ "$AMPLIFY_STATUS" != "null" ] && [ -n "$AMPLIFY_STATUS" ]; then
              DEPLOYMENT_URL=$(echo "$AMPLIFY_STATUS" | jq -r '.target_url // empty')
              STATE=$(echo "$AMPLIFY_STATUS" | jq -r '.state // "pending"')
              
              echo "✅ Found Amplify deployment"
              echo "URL: $DEPLOYMENT_URL"
              echo "State: $STATE"
              
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "state=$STATE" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          if [ "${{ steps.poll-amplify.outputs.found }}" != "true" ]; then
            echo "⏰ Timeout waiting for Amplify deployment"
            echo "deployment_url=" >> $GITHUB_OUTPUT
            echo "state=pending" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Create GitHub deployment
        if: github.event.action != 'closed' && steps.poll-amplify.outputs.found == 'true'
        id: create-deployment
        run: |
          AMPLIFY_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          STATE="${{ steps.poll-amplify.outputs.state }}"
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          
          echo "Creating deployment for PR #${{ steps.pr-info.outputs.pr_number }}"
          echo "Environment: $ENVIRONMENT"
          echo "URL: $AMPLIFY_URL"
          echo "State: $STATE"
          
          # Check if deployment already exists
          EXISTING=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" 2>/dev/null | head -1)
          
          if [ -z "$EXISTING" ]; then
            # Create new deployment
            DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
              -X POST \
              -f ref="${{ steps.pr-info.outputs.pr_sha }}" \
              -f environment="$ENVIRONMENT" \
              -f auto_merge=false \
              -f required_contexts='[]' \
              -f description="Preview deployment for PR #${{ steps.pr-info.outputs.pr_number }}" \
              -f payload="{\"url\":\"$AMPLIFY_URL\",\"pr_number\":\"${{ steps.pr-info.outputs.pr_number }}\"}" \
              --jq '.id' 2>/dev/null || echo "")
            
            if [ -n "$DEPLOYMENT_ID" ]; then
              echo "✅ Created deployment: $DEPLOYMENT_ID"
              echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            else
              echo "⚠️ Failed to create deployment"
              echo "deployment_id=" >> $GITHUB_OUTPUT
            fi
          else
            echo "Deployment already exists: $EXISTING"
            echo "deployment_id=$EXISTING" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update deployment status
        if: steps.create-deployment.outputs.deployment_id != ''
        run: |
          DEPLOYMENT_ID="${{ steps.create-deployment.outputs.deployment_id }}"
          AMPLIFY_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          STATE="${{ steps.poll-amplify.outputs.state }}"
          
          # Map status to deployment state
          case "$STATE" in
            "success")
              DEPLOY_STATE="success"
              DESC="Preview deployment ready on AWS Amplify"
              ;;
            "pending")
              DEPLOY_STATE="in_progress"
              DESC="Deployment in progress on AWS Amplify"
              ;;
            "failure"|"error")
              DEPLOY_STATE="failure"
              DESC="Deployment failed on AWS Amplify"
              ;;
            *)
              DEPLOY_STATE="in_progress"
              DESC="Deployment status: $STATE"
              ;;
          esac
          
          echo "Updating deployment status: $DEPLOY_STATE"
          
          gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
            -X POST \
            -f state="$DEPLOY_STATE" \
            -f description="$DESC" \
            -f environment_url="$AMPLIFY_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment PR with deployment link
        if: steps.create-deployment.outputs.deployment_id != '' && steps.poll-amplify.outputs.deployment_url != ''
        continue-on-error: true
        run: |
          DEPLOYMENT_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          
          COMMENT="## 🚀 Preview Deployment Available
          
          Your PR has been deployed to AWS Amplify!
          
          👉 **[View Preview]($DEPLOYMENT_URL)**
          
          This deployment will automatically update on each push to this PR.
          "
          
          # Check if bot has already commented
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Preview Deployment"))) | .id] | .[0]')
          
          if [ -n "$EXISTING_COMMENT" ] && [ "$EXISTING_COMMENT" != "null" ]; then
            echo "Updating existing comment (ID: $EXISTING_COMMENT)"
            gh api repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT \
              -X PATCH \
              -f body="$COMMENT"
          else
            echo "Creating new comment"
            gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
              -X POST \
              -f body="$COMMENT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up deployment when PR is closed
        if: github.event.action == 'closed'
        run: |
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          
          # Find all deployments for this environment and delete them
          DEPLOYMENTS=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$DEPLOYMENTS" ]; then
            echo "$DEPLOYMENTS" | while read DEPLOY_ID; do
              if [ -n "$DEPLOY_ID" ]; then
                echo "Deleting deployment $DEPLOY_ID"
                gh api repos/${{ github.repository }}/deployments/$DEPLOY_ID \
                  -X DELETE || true
              fi
            done
          else
            echo "No deployments to clean up"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


