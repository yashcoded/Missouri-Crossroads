name: PR Deployment Status

on:
  status:
    # Triggers when commit status changes (including Amplify deployments)
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  sync-deployment-on-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      checks: read
    if: github.event_name == 'status'
    
    steps:
      - name: Check if Amplify status
        id: check-status
        run: |
          CONTEXT="${{ github.event.context }}"
          STATE="${{ github.event.state }}"
          
          # Check if this is an Amplify-related status
          if [[ "$CONTEXT" =~ [Aa]mplify ]]; then
            echo "is_amplify=true" >> $GITHUB_OUTPUT
            echo "context=$CONTEXT" >> $GITHUB_OUTPUT
            echo "state=$STATE" >> $GITHUB_OUTPUT
            echo "target_url=${{ github.event.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "is_amplify=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get PR info for commit
        if: steps.check-status.outputs.is_amplify == 'true'
        id: pr-info
        run: |
          # Find the PR associated with this commit
          PR_INFO=$(gh api repos/${{ github.repository }}/commits/${{ github.event.sha }}/pulls \
            -X GET \
            --jq '.[] | select(.state == "open") | {number: .number, sha: .head.sha}' \
            | head -n 1)
          
          if [ -n "$PR_INFO" ]; then
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
            PR_SHA=$(echo "$PR_INFO" | jq -r '.sha')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
            echo "âœ… Found PR #$PR_NUMBER"
          else
            echo "â­ï¸ No open PR found for this commit"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update GitHub deployment
        if: steps.check-status.outputs.is_amplify == 'true' && steps.pr-info.outputs.pr_number != ''
        id: deployment
        run: |
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          DEPLOYMENT_URL="${{ steps.check-status.outputs.target_url }}"
          STATE="${{ steps.check-status.outputs.state }}"
          
          # Check if deployment already exists
          EXISTING_DEPLOY=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" \
            | head -1)
          
          if [ -z "$EXISTING_DEPLOY" ]; then
            # Create new deployment with proper JSON types
            echo "Creating deployment for PR ${{ steps.pr-info.outputs.pr_number }}"
            JSON_PAYLOAD=$(jq -n \
              --arg ref "${{ steps.pr-info.outputs.pr_sha }}" \
              --arg env "$ENVIRONMENT" \
              --arg desc "Preview deployment for PR #${{ steps.pr-info.outputs.pr_number }}" \
              --arg url "$DEPLOYMENT_URL" \
              --arg pr_num "${{ steps.pr-info.outputs.pr_number }}" \
              '{ref: $ref, environment: $env, auto_merge: false, required_contexts: [], description: $desc, payload: {url: $url, pr_number: $pr_num}}')
            
            DEPLOYMENT_ID=$(echo "$JSON_PAYLOAD" | gh api repos/${{ github.repository }}/deployments \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              --input - \
              --jq '.id')
            
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          else
            echo "Deployment already exists: $EXISTING_DEPLOY"
            echo "deployment_id=$EXISTING_DEPLOY" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update deployment status
        if: steps.deployment.outputs.deployment_id != ''
        run: |
          STATE="${{ steps.check-status.outputs.state }}"
          DEPLOYMENT_ID="${{ steps.deployment.outputs.deployment_id }}"
          
          # Map GitHub status states to deployment states
          case "$STATE" in
            "success")
              DEPLOY_STATE="success"
              DESC="Deployed successfully to Amplify"
              ;;
            "failure"|"error")
              DEPLOY_STATE="failure"
              DESC="Deployment failed on Amplify"
              ;;
            "pending")
              DEPLOY_STATE="in_progress"
              DESC="Deployment in progress on Amplify"
              ;;
            *)
              DEPLOY_STATE="in_progress"
              DESC="Deployment status updated"
              ;;
          esac
          
          gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
            -X POST \
            -f state="$DEPLOY_STATE" \
            -f description="$DESC" \
            -f environment_url="${{ steps.check-status.outputs.target_url }}"
          
          echo "Updated deployment status: $DEPLOY_STATE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  manage-deployment-on-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      checks: read
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Set environment variables
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"
          ACTION="${{ github.event.action }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
      
      - name: Wait and poll for Amplify deployment
        if: github.event.action != 'closed'
        id: poll-amplify
        run: |
          echo "â³ Waiting for AWS Amplify to deploy PR #${{ steps.pr-info.outputs.pr_number }}..."
          echo "ðŸ“ Commit SHA: ${{ steps.pr-info.outputs.pr_sha }}"
          
          # Initialize outputs (always set defaults)
          FOUND="false"
          DEPLOYMENT_URL=""
          STATE="pending"
          
          # Increased timeout to 15 minutes (Amplify builds can take time)
          TIMEOUT=900  # 15 minutes
          ELAPSED=0
          SLEEP_INTERVAL=20  # Check every 20 seconds
          MAX_ATTEMPTS=$((TIMEOUT / SLEEP_INTERVAL))
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo ""
            echo "ðŸ” Checking for Amplify status (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS, ${ELAPSED}s elapsed)..."
            
            STATUSES=$(gh api repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_sha }}/statuses 2>/dev/null || echo "[]")
            
            # Debug: Show all status contexts
            if [ $ATTEMPT -eq 0 ] || [ $((ATTEMPT % 3)) -eq 0 ]; then
              echo "ðŸ“‹ Available status checks:"
              echo "$STATUSES" | jq -r '.[] | "  - \(.context): \(.state)"' || echo "  (none found)"
            fi
            
            # Look for Amplify status - try multiple patterns
            AMPLIFY_STATUS=$(echo "$STATUSES" | jq -r '[.[] | select(.context | ascii_downcase | contains("amplify") or contains("aws") or contains("deploy"))][0]')
            
            if [ "$AMPLIFY_STATUS" != "null" ] && [ -n "$AMPLIFY_STATUS" ]; then
              DEPLOYMENT_URL=$(echo "$AMPLIFY_STATUS" | jq -r '.target_url // empty')
              STATE=$(echo "$AMPLIFY_STATUS" | jq -r '.state // "pending"')
              CONTEXT=$(echo "$AMPLIFY_STATUS" | jq -r '.context // "unknown"')
              
              echo "âœ… Found Amplify deployment!"
              echo "   Context: $CONTEXT"
              echo "   State: $STATE"
              echo "   URL: $DEPLOYMENT_URL"
              
              FOUND="true"
              break
            fi
            
            # If we're past 2 minutes and still no status, provide helpful message
            if [ $ELAPSED -gt 120 ] && [ $((ATTEMPT % 6)) -eq 0 ]; then
              echo "â³ Still waiting... Amplify may be building the app."
              echo "ðŸ’¡ Tip: Check AWS Amplify Console to ensure PR previews are enabled."
            fi
            
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # If not found, log timeout message
          if [ "$FOUND" != "true" ]; then
            echo ""
            echo "â° Timeout after ${TIMEOUT}s waiting for Amplify deployment"
            echo ""
            echo "ðŸ” Final status check results:"
            STATUSES=$(gh api repos/${{ github.repository }}/commits/${{ steps.pr-info.outputs.pr_sha }}/statuses 2>/dev/null || echo "[]")
            echo "$STATUSES" | jq -r '.[] | "  - \(.context): \(.state) (\(.description // "no description"))"' || echo "  (no status checks found)"
            echo ""
            echo "ðŸ’¡ Possible reasons:"
            echo "   1. AWS Amplify PR previews may not be enabled"
            echo "   2. Amplify build is still in progress (check AWS Console)"
            echo "   3. Status check context name doesn't contain 'amplify'"
            echo "   4. Amplify app may not be connected to this repository"
            echo ""
          fi
          
          # Always set outputs (even if not found)
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "found=$FOUND" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Create GitHub deployment
        if: github.event.action != 'closed'
        id: create-deployment
        run: |
          # Safely get outputs with defaults (handle empty values)
          AMPLIFY_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          STATE="${{ steps.poll-amplify.outputs.state }}"
          FOUND="${{ steps.poll-amplify.outputs.found }}"
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          
          # Set defaults if outputs are empty
          AMPLIFY_URL="${AMPLIFY_URL:-}"
          STATE="${STATE:-pending}"
          FOUND="${FOUND:-false}"
          
          echo "Creating deployment for PR #${{ steps.pr-info.outputs.pr_number }}"
          echo "Environment: $ENVIRONMENT"
          echo "Amplify found: $FOUND"
          
          # If Amplify URL was found, use it; otherwise create a placeholder deployment
          if [ "$FOUND" == "true" ] && [ -n "$AMPLIFY_URL" ]; then
            echo "URL: $AMPLIFY_URL"
            echo "State: $STATE"
            DEPLOYMENT_URL="$AMPLIFY_URL"
          else
            echo "âš ï¸ Amplify deployment not found yet - creating placeholder deployment"
            echo "   The deployment will be updated when Amplify status becomes available"
            DEPLOYMENT_URL="https://console.aws.amazon.com/amplify"
            STATE="pending"
          fi
          
          # Check if deployment already exists
          EXISTING=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" 2>/dev/null | head -1)
          
          if [ -z "$EXISTING" ]; then
            # Build description based on whether Amplify was found
            if [ "$FOUND" != "true" ]; then
              DESC="Preview deployment for PR #${{ steps.pr-info.outputs.pr_number }} (Amplify status pending)"
            else
              DESC="Preview deployment for PR #${{ steps.pr-info.outputs.pr_number }}"
            fi
            
            # Create new deployment with proper JSON types
            JSON_PAYLOAD=$(jq -n \
              --arg ref "${{ steps.pr-info.outputs.pr_sha }}" \
              --arg env "$ENVIRONMENT" \
              --arg desc "$DESC" \
              --arg url "$DEPLOYMENT_URL" \
              --arg pr_num "${{ steps.pr-info.outputs.pr_number }}" \
              '{ref: $ref, environment: $env, auto_merge: false, required_contexts: [], description: $desc, payload: {url: $url, pr_number: $pr_num}}')
            
            DEPLOYMENT_ID=$(echo "$JSON_PAYLOAD" | gh api repos/${{ github.repository }}/deployments \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              --input - \
              --jq '.id' 2>/dev/null || echo "")
            
            if [ -n "$DEPLOYMENT_ID" ]; then
              echo "âœ… Created deployment: $DEPLOYMENT_ID"
              echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Failed to create deployment"
              echo "deployment_id=" >> $GITHUB_OUTPUT
            fi
          else
            echo "Deployment already exists: $EXISTING"
            echo "deployment_id=$EXISTING" >> $GITHUB_OUTPUT
            
            # Update existing deployment if we found Amplify URL
            if [ "$FOUND" == "true" ] && [ -n "$AMPLIFY_URL" ]; then
              echo "ðŸ”„ Updating existing deployment with Amplify URL"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update deployment status
        if: steps.create-deployment.outputs.deployment_id != ''
        run: |
          DEPLOYMENT_ID="${{ steps.create-deployment.outputs.deployment_id }}"
          AMPLIFY_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          STATE="${{ steps.poll-amplify.outputs.state }}"
          
          # Set defaults if outputs are empty
          AMPLIFY_URL="${AMPLIFY_URL:-}"
          STATE="${STATE:-pending}"
          
          # Map status to deployment state
          case "$STATE" in
            "success")
              DEPLOY_STATE="success"
              DESC="Preview deployment ready on AWS Amplify"
              ;;
            "pending")
              DEPLOY_STATE="in_progress"
              DESC="Deployment in progress on AWS Amplify"
              ;;
            "failure"|"error")
              DEPLOY_STATE="failure"
              DESC="Deployment failed on AWS Amplify"
              ;;
            *)
              DEPLOY_STATE="in_progress"
              DESC="Deployment status: $STATE"
              ;;
          esac
          
          echo "Updating deployment status: $DEPLOY_STATE"
          
          gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
            -X POST \
            -f state="$DEPLOY_STATE" \
            -f description="$DESC" \
            -f environment_url="$AMPLIFY_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment PR with deployment link
        if: steps.create-deployment.outputs.deployment_id != '' && steps.poll-amplify.outputs.found == 'true' && steps.poll-amplify.outputs.deployment_url != ''
        continue-on-error: true
        run: |
          DEPLOYMENT_URL="${{ steps.poll-amplify.outputs.deployment_url }}"
          
          COMMENT="## ðŸš€ Preview Deployment Available
          
          Your PR has been deployed to AWS Amplify!
          
          ðŸ‘‰ **[View Preview]($DEPLOYMENT_URL)**
          
          This deployment will automatically update on each push to this PR.
          "
          
          # Check if bot has already commented
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Preview Deployment"))) | .id] | .[0]')
          
          if [ -n "$EXISTING_COMMENT" ] && [ "$EXISTING_COMMENT" != "null" ]; then
            echo "Updating existing comment (ID: $EXISTING_COMMENT)"
            gh api repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT \
              -X PATCH \
              -f body="$COMMENT"
          else
            echo "Creating new comment"
            gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
              -X POST \
              -f body="$COMMENT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment PR if Amplify not found
        if: steps.create-deployment.outputs.deployment_id != '' && steps.poll-amplify.outputs.found != 'true'
        continue-on-error: true
        run: |
          COMMENT="## â³ Waiting for AWS Amplify Deployment
          
          The GitHub Actions workflow is waiting for AWS Amplify to start the deployment.
          
          **Possible reasons for delay:**
          - Amplify is building your application (this can take several minutes)
          - PR previews may not be enabled in AWS Amplify Console
          - Check the [AWS Amplify Console](https://console.aws.amazon.com/amplify) for build status
          
          The deployment will be updated automatically once Amplify posts a status check.
          "
          
          # Check if bot has already commented about waiting
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Waiting for AWS Amplify"))) | .id] | .[0]')
          
          if [ -z "$EXISTING_COMMENT" ] || [ "$EXISTING_COMMENT" == "null" ]; then
            echo "Creating waiting comment"
            gh api repos/${{ github.repository }}/issues/${{ steps.pr-info.outputs.pr_number }}/comments \
              -X POST \
              -f body="$COMMENT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up deployment when PR is closed
        if: github.event.action == 'closed'
        run: |
          ENVIRONMENT="pr-${{ steps.pr-info.outputs.pr_number }}"
          
          # Find all deployments for this environment and delete them
          DEPLOYMENTS=$(gh api repos/${{ github.repository }}/deployments \
            --jq ".[] | select(.environment == \"$ENVIRONMENT\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$DEPLOYMENTS" ]; then
            echo "$DEPLOYMENTS" | while read DEPLOY_ID; do
              if [ -n "$DEPLOY_ID" ]; then
                echo "Deleting deployment $DEPLOY_ID"
                gh api repos/${{ github.repository }}/deployments/$DEPLOY_ID \
                  -X DELETE || true
              fi
            done
          else
            echo "No deployments to clean up"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


